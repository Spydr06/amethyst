#include <unistd.h>
#include <stdio.h>
#include <stddef.h>
#include <sys/mount.h>
#include <sys/stat.h>
#include <sys/ioctl.h>
#include <string.h>
#include <stdlib.h>
#include <sys/mman.h>
#include <amethyst/fb.h>

static const struct {
    unsigned int width;
    unsigned int height;
    unsigned int bytes_per_pixel; // RGBA8888 format
    unsigned char data[18 * 18 * 4];
} logo = {
    18, 18, 4,
    {
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0xce, 0xca, 0xf6, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0xfe, 0xe2, 0xe7, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0xfe, 0xe2, 0xe7, 0xff,
        0xfe, 0xe2, 0xe7, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0xce, 0xca, 0xf6, 0xff,
        0xce, 0xca, 0xf6, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0xce, 0xca, 0xf6, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0xfe, 0xe2, 0xe7, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0xce, 0xca, 0xf6, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0xfe, 0xe2, 0xe7, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0xce, 0xca, 0xf6, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00
    }
};

struct target {
    const char* mount_point;
    const char* fs;
};

struct target mount_targets[] = {
    {"/dev", "devfs"},
    {"/tmp", "tmpfs"}
};

void mount_target(struct target* target) {
    int err = mkdir(target->mount_point, 0666);
    if(err) {
        fprintf(stderr, "mkdir: faild creating '%s': %m\n", target->mount_point);
        exit(1);
    }

    err = mount(NULL, target->mount_point, target->fs, 0, NULL);
    if(err) {
        fprintf(stderr, "%s: mount(5) failed: %m\n", target->fs);
        exit(1);
    }
}

void umount_target(struct target* target) {
    int err = umount(target->mount_point);
    if(err) {
        fprintf(stderr, "%s: umount(1) failed: %m\n", target->fs);
        exit(1);
    }
}

int main(int argc, char** argv) {
    printf("Hello, World <3\n");

    for(size_t i = 0; i < sizeof(mount_targets) / sizeof(struct target); i++)
        mount_target(mount_targets + i);
    
    int fb = open("/dev/fb0", O_WRONLY, 0);
    if(!fb) {
        fprintf(stderr, "/dev/fb0: open() failed: %m\n");
        return 1;
    }

    struct fb_var_screeninfo fb_vi;
    ioctl(fb, FBIOGET_VSCREENINFO, &fb_vi);

    struct fb_fix_screeninfo fb_fi;
    ioctl(fb, FBIOGET_FSCREENINFO, &fb_fi);

    void* fb_buf = mmap(NULL, fb_fi.smem_len, PROT_WRITE, MAP_SHARED, fb, 0);
    if(!fb_buf) {
        fprintf(stderr, "/dev/fb0: mmap() failed: %m\n");
    }


    int scale = 6;
    for(size_t y = 0; y < logo.height; y++) {
        for(size_t x = 0; x < logo.width; x++) {
            uint32_t p;
            memcpy(&p, logo.data + (y * logo.width * logo.bytes_per_pixel + x * logo.bytes_per_pixel), fb_vi.bits_per_pixel / 8);

            uint8_t r = p & 0xff;
            uint8_t g = (p & 0xff00) >> 8;
            uint8_t b = (p & 0xff0000) >> 16;

            uint32_t pp = b | g << 8 | r << 16;

            for(size_t sy = y * 6; sy < (y + 1) * 6; sy++) {
                for(size_t sx = x * 6; sx < (x + 1) * 6; sx++) {
                    memcpy(fb_buf + (sy + 16) * fb_fi.line_length + (sx + fb_vi.xres - 128) * fb_vi.bits_per_pixel / 8, &pp, fb_vi.bits_per_pixel / 8);
                }
            }
        }
    }

    close(fb);

    for(size_t i = 0; i < sizeof(mount_targets) / sizeof(struct target); i++)
        umount_target(mount_targets + i);

    while(1);
}

