#include <sys/mman.h>
#include <sys/ioctl.h>
#include <amethyst/fb.h>

#include <stdint.h>
#include <stdlib.h>
#include <memory.h>
#include <errno.h>

static const struct {
    unsigned int width;
    unsigned int height;
    unsigned int bytes_per_pixel; // RGBA8888 format
    unsigned char data[18 * 18 * 4];
} logo = {
    18, 18, 4,
    {
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0xce, 0xca, 0xf6, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0xfe, 0xe2, 0xe7, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0xfe, 0xe2, 0xe7, 0xff,
        0xfe, 0xe2, 0xe7, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0xce, 0xca, 0xf6, 0xff,
        0xce, 0xca, 0xf6, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0xce, 0xca, 0xf6, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0xfe, 0xe2, 0xe7, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0xce, 0xca, 0xf6, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0xfe, 0xe2, 0xe7, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0xdc, 0xa1, 0xe7, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0xce, 0xca, 0xf6, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x75, 0x6c, 0xcb, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x9e, 0x85, 0xdb, 0xff,
        0x4c, 0x45, 0x8c, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x19, 0x1e, 0x41, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0xff,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00
    }
};

int draw_logo_to_fb(int fb, int scale) {
    struct fb_var_screeninfo fb_vi;
    ioctl(fb, FBIOGET_VSCREENINFO, &fb_vi);

    struct fb_fix_screeninfo fb_fi;
    ioctl(fb, FBIOGET_FSCREENINFO, &fb_fi);

    void* fb_buf = mmap(NULL, fb_fi.smem_len, PROT_WRITE, MAP_SHARED, fb, 0);
    if(!fb_buf)
        return ENOMEM;

    for(size_t y = 0; y < logo.height; y++) {
        for(size_t x = 0; x < logo.width; x++) {
            uint32_t p;
            memcpy(&p, logo.data + (y * logo.width * logo.bytes_per_pixel + x * logo.bytes_per_pixel), fb_vi.bits_per_pixel / 8);

            uint8_t r = p & 0xff;
            uint8_t g = (p & 0xff00) >> 8;
            uint8_t b = (p & 0xff0000) >> 16;

            uint32_t pp = b | g << 8 | r << 16;

            for(size_t sy = y * scale; sy < (y + 1) * scale; sy++) {
                for(size_t sx = x * scale; sx < (x + 1) * scale; sx++) {
                    memcpy(fb_buf + (sy + 16) * fb_fi.line_length + (sx + fb_vi.xres - 128) * fb_vi.bits_per_pixel / 8, &pp, fb_vi.bits_per_pixel / 8);
                }
            }
        }
    }

    return munmap(fb_buf, fb_fi.smem_len);
}
